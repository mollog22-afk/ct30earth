<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Pompa di Calore</title>
    <style>
        :root {
            --primary: #0056b3;
            --secondary: #00a8cc;
            --accent: #ff9f1c;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        header p {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        /* Loading Overlay */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; color: var(--primary); font-weight: bold;
            z-index: 1000;
        }

        /* Cards Layout */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 30px;
            transition: transform 0.2s;
        }

        .card-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text); }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            border-color: var(--secondary);
            outline: none;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: background 0.3s;
        }
        .btn:hover { background-color: #004494; }

        /* Results Display */
        .data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .data-item { text-align: center; }
        .data-value { display: block; font-size: 1.2rem; font-weight: bold; color: var(--secondary); }
        .data-label { font-size: 0.85rem; color: var(--text-light); }

        /* Heat Pump Grid */
        .pdc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pdc-card {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .pdc-card:hover { border-color: var(--secondary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .pdc-model { font-weight: bold; margin-bottom: 5px; color: #333; }
        .pdc-sub { font-size: 0.85rem; color: #777; margin-bottom: 10px; }
        
        .pdc-specs {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            background: #f0f8ff;
            padding: 8px;
            border-radius: 6px;
        }
        
        .spec-box { text-align: center; }
        .spec-val { font-weight: bold; color: var(--primary); }
        .spec-lbl { font-size: 0.75rem; color: #555; }

        .badge-cop {
            position: absolute;
            top: 10px; right: 10px;
            background: #e6fffa; color: #00b894;
            padding: 4px 8px; border-radius: 20px;
            font-size: 0.75rem; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="loader">Caricamento database...</div>

    <div class="container">
        <header>
            <h1>Selezionatore Pompe di Calore</h1>
            <p>Trova la soluzione ideale in base alla tua zona climatica</p>
        </header>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="step-number">1</span> Dati Geografici
                </div>
            </div>
            
            <div class="form-group">
                <label for="comuneInput">Inserisci il tuo Comune:</label>
                <input type="text" id="comuneInput" list="comuniList" placeholder="Es. Milano, Roma, Torino..." autocomplete="off">
                <datalist id="comuniList">
                    </datalist>
            </div>

            <div id="zonaResult" class="data-display" style="display:none;">
                <div class="data-item">
                    <span class="data-value" id="valZona">-</span>
                    <span class="data-label">Zona Climatica</span>
                </div>
                <div class="data-item">
                    <span class="data-value" id="valGradi">-</span>
                    <span class="data-label">Gradi Giorno</span>
                </div>
                <div class="data-item">
                    <span class="data-value" id="valAlt">- m</span>
                    <span class="data-label">Altitudine</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <span class="step-number">2</span> Calcolo e Selezione
                </div>
            </div>

            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>Fabbisogno Stimato (kW):</label>
                    <select id="fabbisognoInput" onchange="filtraPdc()">
                        <option value="0">Mostra Tutte</option>
                        <option value="4">4 kW (Piccoli appartamenti)</option>
                        <option value="6">6 kW (Appartamenti medi)</option>
                        <option value="8">8 kW (Case singole standard)</option>
                        <option value="10">10 kW (Case grandi)</option>
                        <option value="12">12 kW+ (Case grandi / poco isolate)</option>
                    </select>
                </div>
                
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>Tipologia:</label>
                    <select id="tipoInput" onchange="filtraPdc()">
                        <option value="all">Tutte le tipologie</option>
                        </select>
                </div>
            </div>

            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                Risultati trovati: <strong id="countPdc">0</strong>
            </p>

            <div id="pdcContainer" class="pdc-grid">
                </div>
        </div>
    </div>

    <script>
        // Stato dell'applicazione
        let dbComuni = [];
        let dbPdc = [];
        
        // Caricamento Dati
        async function initApp() {
            try {
                const [resComuni, resPdc] = await Promise.all([
                    fetch('db_comuni_zone.json'),
                    fetch('db_pompe_calore.json')
                ]);

                if(!resComuni.ok || !resPdc.ok) throw new Error("Errore caricamento file JSON");

                dbComuni = await resComuni.json();
                dbPdc = await resPdc.json();

                popolaComuni();
                popolaFiltriTipo();
                renderPdc(dbPdc.slice(0, 20)); // Mostra i primi 20 all'avvio

                document.getElementById('loader').style.display = 'none';

            } catch (err) {
                document.getElementById('loader').innerHTML = "Errore: " + err.message + "<br><small>Verifica che i file JSON siano nella stessa cartella.</small>";
                document.getElementById('loader').style.color = "red";
            }
        }

        // 1. Gestione Comuni
        function popolaComuni() {
            const dataList = document.getElementById('comuniList');
            // Creiamo un frammento per performance
            const fragment = document.createDocumentFragment();
            
            dbComuni.forEach(c => {
                const opt = document.createElement('option');
                opt.value = `${c.comune} (${c.provincia})`;
                fragment.appendChild(opt);
            });
            dataList.appendChild(fragment);

            // Listener per selezione
            document.getElementById('comuneInput').addEventListener('change', function() {
                const val = this.value;
                const trovato = dbComuni.find(c => `${c.comune} (${c.provincia})` === val);
                
                if (trovato) {
                    document.getElementById('valZona').innerText = trovato.zona_climatica;
                    document.getElementById('valGradi').innerText = trovato.gradi_giorno;
                    document.getElementById('valAlt').innerText = trovato.altitudine;
                    document.getElementById('zonaResult').style.display = 'grid';
                }
            });
        }

        // 2. Gestione Pompe di Calore
        function popolaFiltriTipo() {
            const tipi = [...new Set(dbPdc.map(item => item.tipologia))];
            const select = document.getElementById('tipoInput');
            tipi.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.innerText = t;
                select.appendChild(opt);
            });
        }

        function renderPdc(lista) {
            const container = document.getElementById('pdcContainer');
            container.innerHTML = '';
            document.getElementById('countPdc').innerText = lista.length;

            if(lista.length === 0) {
                container.innerHTML = '<p>Nessuna pompa di calore corrisponde ai criteri.</p>';
                return;
            }

            // Limitiamo la visualizzazione a 50 item per evitare crash del browser se l'utente seleziona "tutti"
            const renderingList = lista.slice(0, 50);

            renderingList.forEach(p => {
                const card = document.createElement('div');
                card.className = 'pdc-card';
                
                // Gestione dati mancanti o null
                const scop = p.scop ? p.scop : (p.efficienza ? p.efficienza + '%' : 'N/A');
                const kw = p.potenza_kw ? p.potenza_kw : 'N/A';
                
                card.innerHTML = `
                    <div class="badge-cop">SCOP ${scop}</div>
                    <div class="pdc-model">${p.modello}</div>
                    <div class="pdc-sub">${p.tipologia}</div>
                    <div style="font-size:0.8rem; color:#888;">Ext: ${p.id_esterna}</div>
                    
                    <div class="pdc-specs">
                        <div class="spec-box">
                            <div class="spec-val">${kw}</div>
                            <div class="spec-lbl">kW Termici</div>
                        </div>
                        <div class="spec-box">
                            <div class="spec-val">${p.gwp}</div>
                            <div class="spec-lbl">GWP Gas</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            if(lista.length > 50) {
                const more = document.createElement('div');
                more.style.gridColumn = "1 / -1";
                more.style.textAlign = "center";
                more.style.padding = "10px";
                more.style.color = "#888";
                more.innerHTML = `<em>Visualizzati 50 di ${lista.length} risultati. Raffina la ricerca.</em>`;
                container.appendChild(more);
            }
        }

        function filtraPdc() {
            const minKw = parseFloat(document.getElementById('fabbisognoInput').value);
            const tipoScelto = document.getElementById('tipoInput').value;

            const filtrati = dbPdc.filter(p => {
                const pKw = parseFloat(p.potenza_kw) || 0;
                
                const checkKw = minKw === 0 || pKw >= minKw; // Mostra se la potenza Ã¨ MAGGIORE o uguale a quella richiesta
                const checkTipo = tipoScelto === 'all' || p.tipologia === tipoScelto;

                return checkKw && checkTipo;
            });

            renderPdc(filtrati);
        }

        // Avvio
        initApp();

    </script>
</body>
</html>
    </script>
</body>
</html>
